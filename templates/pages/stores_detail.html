{% extends "base.html" %}
{% load static %}
{% block main %}
<div class="container nagoyameshi-container mt-4">

  <!-- 店舗情報 -->
  <h2>{{ store.name }}</h2>
  <p>{{ store.description }}</p>
  <p>住所: {{ store.address }}</p>
  <p>カテゴリ:
  {% if store.image %}
    <img src="{{ store.image.url }}" class="img-fluid mb-3" alt="{{ store.name }}">
  {% else %}
    <img src="{% static 'images/noimage.png' %}" class="img-fluid mb-3" alt="No image">
  {% endif %}
  </p>

  <hr>

  <!-- レビュー一覧 -->
  <h3>レビュー</h3>
  <ul class="list-group mb-4">
    {% for review in reviews %}
      <li class="list-group-item">
        <strong>{{ review.reviewer_name }}</strong>
        ({{ review.rating }}★)
        <p>{{ review.comment }}</p>

        {% if user.is_authenticated and is_premium and review.user == user %}
          <!-- 有料会員なら編集/削除可能 -->
          <form method="post" class="mt-2">
            {% csrf_token %}
            <input type="hidden" name="review_id" value="{{ review.id }}">
            <input type="number" name="rating" value="{{ review.rating }}" step="0.5" min="1" max="5" required>
            <textarea name="comment">{{ review.comment }}</textarea>
            <button type="submit" class="btn btn-sm btn-success">更新</button>
          </form>

          <form method="post" action="{% url 'delete_review' review.id %}" class="mt-1">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger">削除</button>
          </form>

        {% elif user.is_authenticated and review.user == user %}
          <!-- 無料会員は表示のみ -->
          <p class="text-muted">（無料会員なので編集・削除はできません）</p>
        {% endif %}
      </li>
    {% empty %}
      <li class="list-group-item">まだレビューはありません。</li>
    {% endfor %}
  </ul>

  <!-- レビュー投稿フォーム -->
  {% if user.is_authenticated and is_premium %}
    <h4>レビューを書く</h4>
    <form method="post">
      {% csrf_token %}
      <input type="number" name="rating" step="0.5" min="1" max="5" required>
      <textarea name="comment"></textarea>
      <button type="submit" class="btn btn-primary">投稿する</button>
    </form>

  {% elif user.is_authenticated %}
    <p class="text-danger">レビュー投稿は有料会員限定です。</p>

  {% else %}
    <p><a href="{% url 'login' %}?next={% url 'store_detail' store.id %}">ログイン</a>してレビューを投稿しましょう。</p>
  {% endif %}

</div>
{% endblock %}
